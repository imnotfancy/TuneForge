import numpy as np
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation, PillowWriter
from mpl_toolkits.mplot3d import Axes3D

def generate_brain_points(num_points=150):
    """Generates points distributed on a sphere surface to simulate a brain volume."""
    indices = np.arange(0, num_points, dtype=float) + 0.5
    phi = np.arccos(1 - 2*indices/num_points)
    theta = np.pi * (1 + 5**0.5) * indices
    
    x = np.cos(theta) * np.sin(phi)
    y = np.sin(theta) * np.sin(phi)
    z = np.cos(phi)
    
    # Flatten the sphere slightly to look more like a brain
    y *= 1.2
    return np.column_stack((x, y, z))

def update(frame, points, ax):
    ax.clear()
    ax.set_facecolor('black')
    
    # Rotate points
    angle = frame * 0.05
    cos_a, sin_a = np.cos(angle), np.sin(angle)
    
    # Rotation matrix around Z axis
    rot_matrix = np.array([
        [cos_a, -sin_a, 0],
        [sin_a, cos_a, 0],
        [0, 0, 1]
    ])
    
    rotated_points = points @ rot_matrix.T
    
    # Plot connections (Plexus effect)
    # We only connect points that are close to each other
    x, y, z = rotated_points[:,0], rotated_points[:,1], rotated_points[:,2]
    
    # Draw points (The Nodes)
    # Randomly brighten some nodes to simulate "thinking"
    colors = np.array(['#00aaaa'] * len(points))
    sizes = np.array([10] * len(points))
    
    # Random neural firing
    firing_indices = np.random.choice(len(points), size=10, replace=False)
    colors[firing_indices] = '#ffffff' # White hot flash
    sizes[firing_indices] = 30
    
    ax.scatter(x, y, z, c=colors, s=sizes, alpha=0.8, edgecolors='none')
    
    # Draw lines (The Synapses) - Simplified logic for performance
    # In a real shader, this is distance-based. Here we hardcode neighbors for visual demo.
    num_lines = 0
    max_lines = 200 # Limit lines for cleaner look
    
    for i in range(len(points)):
        if num_lines > max_lines: break
        # Connect to next 2 points in the array (simplified neighbor)
        for j in range(1, 3):
            if i + j < len(points):
                ax.plot(
                    [x[i], x[i+j]], 
                    [y[i], y[i+j]], 
                    [z[i], z[i+j]], 
                    color='#00aaaa', alpha=0.3, linewidth=0.5
                )
                num_lines += 1

    # Styling
    ax.set_axis_off()
    ax.set_xlim(-1.5, 1.5)
    ax.set_ylim(-1.5, 1.5)
    ax.set_zlim(-1.5, 1.5)

# Setup
points = generate_brain_points(100)
fig = plt.figure(figsize=(5, 5), dpi=100)
fig.patch.set_facecolor('black')
ax = fig.add_subplot(111, projection='3d')

# Create Animation
ani = FuncAnimation(fig, update, frames=60, fargs=(points, ax), interval=50)

# Save
output_path = "brain_plexus_animation.gif"
ani.save(output_path, writer=PillowWriter(fps=20))
print(output_path)